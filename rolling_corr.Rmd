---
title: "Rolling correlation"
date: "`r Sys.Date()`"
output: 
  html_document:
    df_print: paged
---



```{r setup, include=F}

library(ape)
library(phytools)
library(ontophylo)
library(dplyr)
library(parallel)
library(viridis)
library(ggplot2)
library(deeptime)
library(mgcv)
source("R/utils-ST.R")
source('R/region_class.R')


knitr::opts_chunk$set(
  echo = TRUE,       # show code by default
  warning = FALSE,
  message = FALSE
)
```


# Read and Make Data

```{r}

tree <-readRDS("data/hym_tree.RDS")

# read mean rates
rates <-readRDS("data_out/br_rates_all_ind.RDS")
rates <- do.call(cbind,rates)
# drop larva
rates <- rates[,-16]
class(rates)
dim(rates)

rate_whole_branch <- apply(rates, 1, sum)

```

# Prepare data

```{r}
edge_times <- edge_times_from_tips(tree)
head(edge_times)
count_branches_sliding(edge_times, window_size = 40, step_size = 1, plot = TRUE)
```


# Run rolling window correlation
```{r}

cor_results <- rolling_rate_correlation(rates, edge_times,
                                        window_size = 40, 
                                        step_size = 1,
                                        trim_quantiles = NULL,  
                                        log_transform = TRUE,
                                        use.abs.value=TRUE)
```


# Convert correlation
```{r}
df_cor <- cor_list_to_df(cor_results)
head(df_cor)


df_avg <- df_cor %>%
  group_by(time) %>%
  summarize(
    median_cor = median(cor, na.rm = TRUE),
    mean_cor = mean(cor, na.rm = TRUE),
    se = sd(cor, na.rm = TRUE) / sqrt(n()),
    sd = sd(cor, na.rm = TRUE),
    q25 = quantile(cor, 0.25, na.rm = TRUE),
    q75 = quantile(cor, 0.75, na.rm = TRUE)
  )
head(df_avg)
saveRDS(df_avg,'data_out/df_avg.rds')
```

# Plot rolling corr

```{r}
p <- ggplot(df_avg, aes(x = time, y = median_cor)) +
  geom_line(color = "black") +
  geom_ribbon(aes(ymin = q25, ymax = q75),
              alpha = 0.2, fill = "grey") +
  scale_x_reverse(
    breaks = seq(0, 300, by = 25),
    expand = c(0, 0)
  ) +
  theme_classic() +
  labs(y = "Median pairwise correlation", x = "Time (Ma)")

p
ggsave("figures/metrics_thru_time/rolling-corr.pdf", p, width = 3.5*2, height = 1.6*2, dpi = 300, units = "in")
```


