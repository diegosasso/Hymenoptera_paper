---
title: "Make pyrate mcmc data"
date: "`r Sys.Date()`"
output: 
  html_document:
    df_print: paged
---

Make pyrate mcmc data ready for downstream analyses.

The data are from: Jouault, C., Oyama, N., Álvarez-Parra, S., Huang, D., Perrichot, V., Condamine, F.L. and Legendre, F., 2025. The radiation of Hymenoptera illuminated by Bayesian inferences from the fossil record. Current Biology, 35(9), pp.2164-2174.

The Birth–Death model with constrained shifts, and without (BDCS-fam-ssing-20) singletons.

```{r setup, include=F}
# rm(list = ls())
library(ape)
library(phytools)
library(ontophylo)
library(dplyr)
library(parallel)
library(viridis)
library(ggplot2)
library(abind)
library(dplyr)
library(purrr)
library(readr)
library(tidyr)
library(stringr)
library(deeptime)
source("R/utils-ST.R")
source('R/region_class.R')


knitr::opts_chunk$set(
  echo = TRUE,       # show code by default
  warning = FALSE,
  message = FALSE
)
```



## Read without singletons (BDCS-fam-ssing-20)

It has fixed times of rate shift: 260.0 240.0 220.0 200.0 180.0 160.0 140.0 120.0 100.0 80.0 60.0 40.0 20.0 

```{r}
# File pattern
files <- sprintf("data_pyrate/BDCS/BDCS-fam-ssing-20/Te_Ts-RJMCMC4_%d__BDCS12_BDS_mcmc.log", 0:9)

# Read header from the first file
header <- names(read_tsv(files[1], n_max = 1, show_col_types = FALSE))

# Function to read last n lines, using the known header
read_last_lines <- function(file, n = 200) {
  lines <- readLines(file)
  total_lines <- length(lines)
  data_lines <- tail(lines, n)
  
  # Create a temporary file with header + data lines
  tmp <- tempfile(fileext = ".tsv")
  writeLines(c(paste(header, collapse = "\t"), data_lines), tmp)
  
  read_tsv(tmp, show_col_types = FALSE)
}

# Combine last 100 lines from all 10 runs
mcmc_combined <- map_dfr(files, read_last_lines, .id = "run_id")

# Inspect
nrow(mcmc_combined)
head(mcmc_combined)
```

### mean root age
```{r}
mean_root_age <- mcmc_combined %>%
  summarise(mean_root_age = mean(root_age, na.rm = TRUE)) %>%
  pull(mean_root_age)

mean_root_age
```


### Claculate and summarize diversification

```{r}

# Identify all lambda columns
lambda_cols <- grep("^lambda_", names(mcmc_combined), value = TRUE)

# Compute diversification rates as lambda_i - mu_i
mcmc_div <- mcmc_combined %>%
  mutate(across(all_of(lambda_cols), 
                ~ . - get(str_replace(cur_column(), "lambda_", "mu_")),
                .names = "div_{str_replace(.col, 'lambda_', '')}"))

# Inspect results
mcmc_div %>%
  select(starts_with("div_")) %>%
  head()
```

### Summarise posterior for each div_k

```{r}
div_sum <- mcmc_div %>%
  select(starts_with("div_")) %>%
  pivot_longer(everything(), names_to = "bin", values_to = "div") %>%
  mutate(bin = as.integer(str_extract(bin, "\\d+"))) %>%
  group_by(bin) %>%
  summarise(
    mean = mean(div, na.rm = TRUE),
    # lower  = quantile(div, 0.025, na.rm = TRUE),
    # upper  = quantile(div, 0.975, na.rm = TRUE),
    # lower  = quantile(div, 0.15, na.rm = TRUE),
    # upper  = quantile(div, 0.85, na.rm = TRUE),
    lower  = quantile(div, 0.25, na.rm = TRUE),
    upper  = quantile(div, 0.75, na.rm = TRUE),
    .groups = "drop"
  )
```


### Save

```{r}
saveRDS(div_sum, file='data_out/pyrate-dive.RDS')
```


### Plot
```{r}

# 2) Order bins according to your intervals (from oldest to youngest interval)
#    bin 0 = [260,265], bin 1 = [240,260], ..., bin 13 = [0,20]
bins_order <- 0:13
y_med <- div_sum$mean[match(bins_order, div_sum$bin)]
y_low <- div_sum$lower[ match(bins_order, div_sum$bin)]
y_up  <- div_sum$upper[ match(bins_order, div_sum$bin)]

# 3) Interval edges (past→present)
edges <- c(265, 260, 240, 220, 200, 180, 160, 140, 120, 100, 80, 60, 40, 20, 0)

# 4) Build horizontal and vertical segments for MEDIAN
h_med <- tibble(
  x    = edges[-length(edges)],
  xend = edges[-1],
  y    = y_med,
  yend = y_med
)

v_med <- tibble(
  x    = edges[-c(1, length(edges))],
  xend = edges[-c(1, length(edges))],
  y    = y_med[-length(y_med)],
  yend = y_med[-1]
)

# 5) (Optional) same for LOWER and UPPER as dashed envelopes
h_low <- mutate(h_med, y = y_low, yend = y_low)
v_low <- tibble(
  x    = edges[-c(1, length(edges))],
  xend = edges[-c(1, length(edges))],
  y    = y_low[-length(y_low)],
  yend = y_low[-1]
)

h_up <- mutate(h_med, y = y_up, yend = y_up)
v_up <- tibble(
  x    = edges[-c(1, length(edges))],
  xend = edges[-c(1, length(edges))],
  y    = y_up[-length(y_up)],
  yend = y_up[-1]
)

# 6) Plot: past→present (reverse x), step as segments
ggplot() +
  # CI (dashed)
  geom_segment(data = h_low, aes(x = x, xend = xend, y = y, yend = yend),
               linetype = "dashed") +
  geom_segment(data = v_low, aes(x = x, xend = xend, y = y, yend = yend),
               linetype = "dashed") +
  geom_segment(data = h_up,  aes(x = x, xend = xend, y = y, yend = yend),
               linetype = "dashed") +
  geom_segment(data = v_up,  aes(x = x, xend = xend, y = y, yend = yend),
               linetype = "dashed") +
  # Median (solid)
  geom_segment(data = h_med, aes(x = x, xend = xend, y = y, yend = yend),
               linewidth = 1) +
  geom_segment(data = v_med, aes(x = x, xend = xend, y = y, yend = yend),
               linewidth = 1) +
  scale_x_reverse(breaks = c(265, 260, 240, 220, 200, 180, 160, 140, 120, 100, 80, 60, 40, 20, 0)) +
  labs(x = "Time (Ma)", y = "Diversification (λ − μ)",
       title = "Diversification through time (step function with 95% CI)") +
  theme_minimal()
```

### Convert Pyrate to stepping function and Plot



```{r}

make_steps <- function(y, edges){
  #    (265, y0) → (260, y0) → (260, y1) → (240, y1) → ... → (0, y13)
  x_step <- c(rbind(edges[-length(edges)], edges[-1]))
  y_step <- rep(y, each = 2)
  list(x_step=x_step, y_step=y_step)
}


# 1) Order bins to match intervals: [260,265], [240,260], ..., [0,20]
#bins_order <- 1:13
edges <- c(265, 260, 240, 220, 200, 180, 160, 140, 120, 100, 80, 60, 40, 20, 0)
# y should be from oldest to present
y <- div_sum$mean[1:14]
y_up <- div_sum$upper[1:14]
y_low <- div_sum$lower[1:14]

py_div_step <- make_steps(y, edges)
py_div_step_up <- make_steps(y_up, edges)
py_div_step_low <- make_steps(y_low, edges)


plot(py_div_step$x_step, py_div_step$y_step, type = "l", xlim = c(265, 0), ylim=c(-0.1, 0.15))
lines(py_div_step_up$x_step, py_div_step_up$y_step, col='red')
lines(py_div_step_low$x_step, py_div_step_up$y_step, col='red')

# 4) Plot with base R (past→present)
plot(py_div_step$x_step, py_div_step$y_step, type = "l", xlim = c(265, 0),
     xlab = "Time (Ma)", ylab = "Diversification (λ − μ)"
     )

```
###  Plot 50%  Confidence

```{r}

plot(py_div_step$x_step, py_div_step$y_step, type = "l", xlim = c(265, 0), ylim=c(-0.1, 0.15))
lines(py_div_step_up$x_step, py_div_step_up$y_step, col='red')
lines(py_div_step_low$x_step, py_div_step_low$y_step, col='red')

```

```{r}
neff_repl <- read_rds('data_out/neff-per-replicate.RDS')
head(neff_repl)
```


```{r}
ggplot() +
  geom_ribbon(data = neff_repl, aes(x = time, ymin = lower, ymax = upper),
              fill = "blue", alpha = 0.2) +
  scale_x_reverse(breaks = seq(0, 280, by = 50)) +
  geom_line(data = neff_repl, aes(x = time, y = mean_entropy),
            color = "black", size = 1) +
  theme_minimal()
```






```{r}

df_div <- tibble(
  time  = py_div_step$x_step,
  div   = py_div_step$y_step,
  lower = py_div_step_low$y_step,   # <-- note: use LOW y here
  upper = py_div_step_up$y_step     # <-- and UP y here
)

df_div <- df_div %>%
  rename(lower_div = lower, upper_div = upper)

p <- ggplot() +
  # Diversification (ochre)
  geom_ribbon(data = df_div,
              aes(x = time, ymin = lower_div*40 + 2.5, ymax = upper_div*40 + 2.5),
              fill = "#D9B27C", alpha = 0.55) +
  geom_line(data = df_div,
            aes(x = time, y = div*40 + 2.5),
            color = "#A66E2E", linewidth = 1.1) +
  
  # Neff (green)
  geom_ribbon(data = neff_repl,
              aes(x = time, ymin = lower, ymax = upper),
              fill = "#33a02c", alpha = 0.45) +
  geom_line(data = neff_repl,
            aes(x = time, y = mean_entropy),
            color = "#006d2c", linewidth = 0.6) +
  
    # Geological bar
  coord_geo(
    dat = "periods",
    pos = "bottom",
    size = 3,
    expand = FALSE,
    height = unit(0.25, "cm"),
    lab = FALSE
  ) +
  
  # Axes
  scale_x_reverse(expand = c(0, 0),
                  breaks = seq(0, 300, 50)) +
  scale_y_continuous(
    limits = c(-0.1, 6),
    name = expression(N[eff]),  # left y-axis label
    sec.axis = sec_axis(~ (. - 2.5) / 40,
                        name = expression(r ))  # right axis for diversification
  ) +
  
  # Theme
  theme_classic(base_size = 14) +
  theme(
    #panel.border = element_rect(color = "black", fill = NA, linewidth = 1.9),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    axis.text = element_text(color = "black"),
    
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    
    panel.grid = element_blank(),
    axis.title.y.left  = element_text(color = "#006d2c"),
    axis.title.y.right = element_text(color = "#A66E2E")
  ) +
  labs(x = "Time (Ma)")

p

ggsave("figures/neff/neff-pyrate.pdf", p, width = 3.5*2, height = 1.6*2, dpi = 300, units = "in")

```




