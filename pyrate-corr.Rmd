---
title: "Correlation between pyrate rates and other metrics"
date: "`r Sys.Date()`"
output: 
  html_document:
    df_print: paged
---



```{r setup, include=F}
library(ape)
library(phytools)
library(ontophylo)
library(dplyr)
library(parallel)
library(viridis)
library(ggplot2)
library(abind)
library(dplyr)
library(purrr)
library(readr)
library(tidyr)
library(stringr)
library(deeptime)
source("R/utils-ST.R")
source('R/region_class.R')


knitr::opts_chunk$set(
  echo = TRUE,       # show code by default
  warning = FALSE,
  message = FALSE
)
```




## Read data

```{r}

# Neff
neff_repl <- readRDS('data_out/neff-per-replicate.RDS')
head(neff_repl)

# Pyrate div
div_sum <- readRDS('data_out/pyrate-dive.RDS')
head(div_sum)

# Disparity
#dis_tb <- readRDS("data_out/data_disparity_final.RDS")
dis_tb <- readRDS("data_out/data_disparity_var-hm.RDS")
# !!! This may not be necessary
# dis_tb <- dis_tb %>%
#   arrange(Time) %>%
#   mutate(Time = rev(Time))
head(dis_tb)

# Rate thru time adult
rates_thru_time <- readRDS('data_out/rates-thru-time.RDS')
head(rates_thru_time)

# Rate thru time larva
rates_thru_time_la <- readRDS('data_out/rates-thru-time-larva.RDS')
head(rates_thru_time_la)
```


## Make average Neff

```{r}
# bin edges
bins <- c(265, seq(260, 0, by = -20) )  
length(bins)

# cut times into bins (right=FALSE so [lower,upper) )
neff_repl$bin <- cut(neff_repl$time, breaks=bins, right=FALSE)

# average per bin
avg_neff <- aggregate(mean_entropy ~ bin, data=neff_repl, FUN=mean)
avg_neff
plot(avg_neff)

avg_mean_f_plus <- aggregate(mean_f_plus ~ bin, data=neff_repl, FUN=mean)
avg_mean_f_plus
plot(avg_mean_f_plus)

avg_mean_log_f_plus <- aggregate(mean_log_f_plus ~ bin, data=neff_repl, FUN=mean)
avg_mean_H_plus <- aggregate(mean_H_plus ~ bin, data=neff_repl, FUN=mean)

```

## Make average Disparity

```{r}
# bin edges
bins <- c(265, seq(260, 0, by = -20) )  
length(bins)

# cut times into bins (right=FALSE so [lower,upper) )
dis_tb$bin <- cut(dis_tb$Time, breaks=bins, right=FALSE)

# average per bin
avg_dis <- aggregate(Mean_norm_disparity ~ bin, data=dis_tb, FUN=mean)
avg_dis
plot(avg_dis)
```
## Make average Rate Adult

```{r}
# bin edges
bins <- c(265, seq(260, 0, by = -20) )  
length(bins)

rates_thru_time$bin <- cut(rates_thru_time$time, breaks=bins, right=FALSE)

# average per bin
avg_rate <- aggregate(mean ~ bin, data=rates_thru_time, FUN=mean)
avg_rate
plot(avg_rate)
```

## Make average Rate Larva

```{r}
# bin edges
bins <- c(265, seq(260, 0, by = -20) )  
length(bins)

rates_thru_time_la$bin <- cut(rates_thru_time_la$time, breaks=bins, right=FALSE)

# average per bin
avg_rate_la <- aggregate(mean ~ bin, data=rates_thru_time_la, FUN=mean)
avg_rate_la
plot(avg_rate_la)
```


## Make final

```{r}
# get metrics and remove last bin
py_div <- div_sum$mean[-1]
neff_r <- rev(avg_neff[,2])[-1]
dis_r <- rev(avg_dis[,2])[-1]
rate_r <- rev(avg_rate[,2])[-1]
rate_la <- rev(avg_rate_la[,2])[-1]
```


## Pyrate vs. Neff

```{r}

plot(neff_r, py_div)     
model <- lm(py_div ~ neff_r)       
abline(model, col = "red", lwd = 2) 

cor.test(neff_r, py_div, method = 'pearson')

```
### Plot

```{r}
plot(neff_r, type = 'l', ylim=c(-0.03, 1.7))
lines(py_div*10, col='red')
```



### Plot steps

```{r}

edges <- c(260, 240, 220, 200, 180, 160, 140, 120, 100, 80, 60, 40, 20, 0)

py_div_step <- make_steps(py_div, edges)
neff_step <- make_steps(neff_r, edges)

plot(neff_step$x_step, neff_step$y_step, type = "l", xlim = c(265, 0), ylim=c(-0.07, 1.7))

lines(py_div_step$x_step, py_div_step$y_step*17+0.5, xlim = c(265, 0), col='red')

```



## Pyrate vs. Disp

```{r}

plot(dis_r, py_div)     
model <- lm(py_div ~ dis_r)       
abline(model, col = "red", lwd = 2) 

cor.test(dis_r, py_div, method = 'pearson')

```

```{r}
plot(dis_r, type = 'l', ylim=c(-10, 100))
lines(py_div*800, col='red')
```



## Pyrate vs. Rate Adult

```{r}

plot(rate_r, py_div)     
model <- lm(py_div ~ rate_r)       
abline(model, col = "red", lwd = 2) 

cor.test(rate_r, py_div, method = 'pearson')
```

## Pyrate vs. Rate Larval

```{r}

plot(rate_la, py_div)     
model <- lm(py_div ~ rate_la)       
abline(model, col = "red", lwd = 2) 

cor.test(rate_la, py_div, method = 'pearson')

```


## Tesing effect of Neff and its components

### Make Neff components

```{r}
f_plus_r <- rev(avg_mean_f_plus[,2])[-1]
log_f_plus_r <- rev(avg_mean_log_f_plus[,2])[-1]
H_plus_r <- rev(avg_mean_H_plus[,2])[-1]
```



### Linear regression: Neff, Pyrate, Disp

```{r}
df <- data.frame(
  py_div = py_div,
  neff_r = neff_r,
  dis_r  = dis_r
  
)

model <- lm(py_div ~ neff_r + dis_r, data = df)
summary(model)
```

#### Collinearity
```{r}

cor(df$neff_r, df$dis_r)
car::vif(lm(py_div ~ neff_r + dis_r, data = df))
```




### Relative imporance: Neff components

#### Linear regression, contributions

```{r}

df <- data.frame(
  py_div = py_div,
  neff_r = neff_r,
  f_plus_r=f_plus_r,
  log_f_plus_r = log_f_plus_r,
  H_plus_r = H_plus_r
  
)

m1 <- lm(py_div ~ log_f_plus_r * H_plus_r, data = df)
summary(m1)

m2 <- lm(py_div ~ f_plus_r * H_plus_r, data = df)
summary(m2)

m3 <- lm(py_div ~ log_f_plus_r + H_plus_r, data = df)
summary(m3)

AIC(m1)
AIC(m2)
AIC(m3)
```


#### Relative importance analysis

```{r}
library(relaimpo)
calc.relimp(m1, type = "lmg")
```

#### Absolute importance

```{r}
rel <- calc.relimp(m1, type = "lmg")$lmg
rel / sum(rel)
```

