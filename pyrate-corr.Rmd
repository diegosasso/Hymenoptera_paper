---
title: "Correlation between pyrate rates and other metrics"
date: "`r Sys.Date()`"
output: 
  html_document:
    df_print: paged
---



```{r setup, include=F}
library(ape)
library(phytools)
library(ontophylo)
library(dplyr)
library(parallel)
library(viridis)
library(ggplot2)
library(abind)
library(dplyr)
library(purrr)
library(readr)
library(tidyr)
library(stringr)
library(deeptime)
source("R/utils-ST.R")
source('R/region_class.R')


knitr::opts_chunk$set(
  echo = TRUE,       # show code by default
  warning = FALSE,
  message = FALSE
)
```




## Read data

```{r}

# Neff
neff_repl <- read_rds('data_out/neff-per-replicate.RDS')
head(neff_repl)

# Pyrate div
div_sum <- read_rds('data_out/pyrate-dive.RDS')
head(div_sum)

# Disparity
dis_tb <- readRDS("data_out/data_disparity_final.RDS")
# !!! This may not be necessary
dis_tb <- dis_tb %>%
  arrange(Time) %>%
  mutate(Time = rev(Time))
head(dis_tb)

# Rate thru time
rates_thru_time <- readRDS('data_out/rates-thru-time.RDS')
head(rates_thru_time)
```

```{r}
# # rescale time in neff_repl to match pyrate div_sum 
# X <- 264.7/280
# neff_repl_rescaled <- neff_repl %>%
#   mutate(time_rescaled = time * X)
# head(neff_repl_rescaled)
```


## Make average Neff

```{r}
# bin edges
bins <- c(265, seq(260, 0, by = -20) )  
length(bins)

# cut times into bins (right=FALSE so [lower,upper) )
#neff_repl_rescaled$bin <- cut(neff_repl_rescaled$time_rescaled, breaks=bins, right=FALSE)
neff_repl$bin <- cut(neff_repl$time, breaks=bins, right=FALSE)

# average per bin
avg_neff <- aggregate(mean_entropy ~ bin, data=neff_repl, FUN=mean)
#avg_neff <- aggregate(median ~ bin, data=neff_repl_rescaled, FUN=mean)
avg_neff
plot(avg_neff)
```

## Make average Disparity

```{r}
# bin edges
bins <- c(265, seq(260, 0, by = -20) )  
length(bins)

# cut times into bins (right=FALSE so [lower,upper) )
#neff_repl_rescaled$bin <- cut(neff_repl_rescaled$time_rescaled, breaks=bins, right=FALSE)
dis_tb$bin <- cut(dis_tb$Time, breaks=bins, right=FALSE)

# average per bin
avg_dis <- aggregate(Norm_Disparity ~ bin, data=dis_tb, FUN=mean)
avg_dis
plot(avg_dis)
plot(avg_dis$bin, avg_dis$Norm_Disparity)
```
## Make average Rate

```{r}
# bin edges
bins <- c(265, seq(260, 0, by = -20) )  
length(bins)

rates_thru_time$bin <- cut(rates_thru_time$time, breaks=bins, right=FALSE)

# average per bin
avg_rate <- aggregate(mean ~ bin, data=rates_thru_time, FUN=mean)
avg_rate
plot(avg_rate)
```


## Pyrate vs. Neff

```{r}

neff_r <- rev(avg_neff[,2])
py_div <- div_sum$mean

plot(neff_r, py_div)

cor.test(neff_r, py_div, method = 'pearson')

cor.test(neff_r[-1], py_div[-1], method = 'pearson')
```


```{r}
plot(neff_r, type = 'l', ylim=c(-0.03, 1.7))
lines(py_div*10, col='red')
```

```{r}
plot(neff_r[-1], type = 'l', ylim=c(-0.03, 1.7))
lines(py_div[-1]*10, col='red')
```


## Pyrate vs. Disp

```{r}

dis_r <- rev(avg_dis[,2])
py_div <- div_sum$mean

plot(dis_r, py_div)

cor.test(dis_r, py_div, method = 'pearson')

cor.test(dis_r[-1], py_div[-1], method = 'pearson')
```

## Pyrate vs. Rate

```{r}

rate_r <- rev(avg_rate[,2])
py_div <- div_sum$mean

plot(rate_r, py_div)

cor.test(rate_r, py_div, method = 'pearson')

cor.test(rate_r[-1], py_div[-1], method = 'pearson')
```
## Rate vs. Dispr

```{r}


plot(rate_r, dis_r)

cor.test(rate_r, dis_r, method = 'pearson')

cor.test(rate_r[-1], dis_r[-1], method = 'pearson')
```


## Linear regression

```{r}
df <- data.frame(
  py_div = py_div[-1],
  neff_r = neff_r[-1],
  dis_r  = dis_r[-1], 
  rate_r=rate_r[-1]
)

model <- lm(py_div ~ neff_r + dis_r + rate_r, data = df)
summary(model)

```





